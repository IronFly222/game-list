<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tier Games</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Tier Games</h1>
    
    <div id="authSection" class="mb-4">
      <button id="signInBtn" class="bg-blue-500 text-white px-4 py-2 rounded">Iniciar sesión</button>
      <button id="signOutBtn" class="bg-red-500 text-white px-4 py-2 rounded hidden">Cerrar sesión</button>
      <span id="usernameDisplay" class="ml-4 font-bold"></span>
    </div>

    <div id="registerSection" class="mb-4 hidden">
      <input id="usernameInput" type="text" placeholder="Tu nombre único" class="border px-2 py-1"/>
      <button id="registerBtn" class="bg-green-500 text-white px-4 py-1 rounded">Registrar nombre</button>
    </div>

    <div class="mb-4">
      <input id="gameNameInput" type="text" placeholder="Nombre del juego" class="border px-2 py-1"/>
      <button id="addGameBtn" class="bg-purple-500 text-white px-4 py-1 rounded">Añadir juego</button>
    </div>

    <div id="gamesList" class="space-y-2"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, collection, addDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Tu configuración
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "tier-games.firebaseapp.com",
      projectId: "tier-games",
      storageBucket: "tier-games.appspot.com",
      messagingSenderId: "tu-id",
      appId: "tu-app-id"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    const signInBtn = document.getElementById("signInBtn");
    const signOutBtn = document.getElementById("signOutBtn");
    const registerSection = document.getElementById("registerSection");
    const usernameInput = document.getElementById("usernameInput");
    const registerBtn = document.getElementById("registerBtn");
    const usernameDisplay = document.getElementById("usernameDisplay");
    const gameNameInput = document.getElementById("gameNameInput");
    const addGameBtn = document.getElementById("addGameBtn");
    const gamesList = document.getElementById("gamesList");

    let currentUser = null;
    let userDoc = null;
    let settings = { maxVotes: 5 };

    async function loadSettings() {
      const settingsDoc = await getDoc(doc(db, "meta", "settings"));
      if (settingsDoc.exists()) {
        settings = settingsDoc.data();
      }
    }

    async function registerUsername() {
      const username = usernameInput.value.trim();
      if (!username) return alert("Nombre no válido");
      const usernameRef = doc(db, "usernames", username.toLowerCase());
      const usernameSnap = await getDoc(usernameRef);
      if (usernameSnap.exists()) return alert("Nombre ya en uso");

      const userRef = doc(db, "users", currentUser.uid);
      await setDoc(userRef, { username, votesUsed: 0 }, { merge: true });
      await setDoc(usernameRef, { uid: currentUser.uid });
    }

    async function voteGame(gameId, gameData) {
      const userRef = doc(db, "users", currentUser.uid);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.data();
      if (userData.votesUsed >= settings.maxVotes) return alert("Ya has usado todos tus votos");
      if (gameData.voters && gameData.voters[currentUser.uid]) return alert("Ya votaste este juego");

      const gameRef = doc(db, "games", gameId);
      const newVoters = { ...(gameData.voters || {}) };
      newVoters[currentUser.uid] = userData.username;

      await updateDoc(userRef, { votesUsed: userData.votesUsed + 1 });
      await updateDoc(gameRef, {
        votes: gameData.votes + 1,
        voters: newVoters
      });
    }

    function renderGames(games) {
      gamesList.innerHTML = "";
      games.forEach(([id, data]) => {
        const div = document.createElement("div");
        div.className = "bg-white p-2 rounded shadow flex justify-between items-center";

        const info = document.createElement("div");
        info.innerText = `${data.name} - Votos: ${data.votes || 0}`;
        div.appendChild(info);

        const btn = document.createElement("button");
        btn.innerText = "Votar";
        btn.className = "bg-blue-500 text-white px-2 py-1 rounded";
        btn.onclick = () => voteGame(id, data);
        div.appendChild(btn);

        gamesList.appendChild(div);
      });
    }

    async function loadGames() {
      onSnapshot(collection(db, "games"), snapshot => {
        const games = snapshot.docs.map(doc => [doc.id, doc.data()]);
        renderGames(games);
      });
    }

    signInBtn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
    signOutBtn.onclick = () => signOut(auth);

    registerBtn.onclick = async () => {
      await registerUsername();
      registerSection.classList.add("hidden");
    };

    addGameBtn.onclick = async () => {
      const name = gameNameInput.value.trim();
      if (!name) return;
      await addDoc(collection(db, "games"), {
        name,
        votes: 0,
        voters: {}
      });
      gameNameInput.value = "";
    };

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        signInBtn.classList.add("hidden");
        signOutBtn.classList.remove("hidden");

        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
          registerSection.classList.remove("hidden");
        } else {
          usernameDisplay.innerText = userSnap.data().username;
          registerSection.classList.add("hidden");
        }

        loadSettings();
        loadGames();
      } else {
        currentUser = null;
        signInBtn.classList.remove("hidden");
        signOutBtn.classList.add("hidden");
        registerSection.classList.add("hidden");
        gamesList.innerHTML = "";
        usernameDisplay.innerText = "";
      }
    });
  </script>
</body>
</html>
