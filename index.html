<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lista de Juegos en Grupo — Realtime</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-900 text-white min-h-screen flex flex-col items-center p-6">
    <div class="w-full max-w-2xl">
      <header class="text-center mb-6">
        <h1 class="text-4xl font-extrabold">🎮 Lista de Juegos del Grupo</h1>
        <p id="projectInfo" class="mt-2 text-sm text-slate-400">Conectando a Firebase...</p>
      </header>

      <!-- Formulario para agregar -->
      <div class="bg-slate-800 p-4 rounded shadow">
        <input id="gameInput" type="text" placeholder="Escribe un juego..." class="w-full p-3 rounded text-black mb-3" />
        <div class="flex gap-2">
          <button id="addBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 p-3 rounded font-semibold">Agregar Juego</button>
          <button id="forceBtn" class="bg-slate-700 hover:bg-slate-600 p-3 rounded">Forzar re-listener</button>
        </div>
      </div>

      <!-- Lista -->
      <ul id="gameList" class="mt-6 space-y-3"></ul>

      <!-- Área de debug visible (útil para comprobar proyecto) -->
      <div class="mt-6 text-xs text-slate-400">
        <p>Consejo: abre esta página en dos pestañas, añade un juego en una y mira si aparece automáticamente en la otra.</p>
        <p class="mt-2">Si no se sincroniza, mira la consola (F12) para mensajes de depuración y compara el <strong>Proyecto</strong> que se muestra arriba.</p>
      </div>
    </div>

    <script>
      // -------------------------------
      // 1) Pega aquí TU CONFIG DE FIREBASE
      // -------------------------------
      const firebaseConfig = {
  apiKey: "AIzaSyCpTw_SMdA8WezIHYh-L6bbzy6KIHagdX4",
  authDomain: "games-for-play.firebaseapp.com",
  projectId: "games-for-play",
  storageBucket: "games-for-play.firebasestorage.app",
  messagingSenderId: "1064304946115",
  appId: "1:1064304946115:web:057fa88f7e12fea841ab76"
};

      // No tocar más abajo si solo has cambiado las claves.

      // Inicializa Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const gamesRef = db.collection('games');

      // Muestra info del proyecto en la UI para verificar que todas las pestañas usen el mismo proyecto
      const projectInfo = document.getElementById('projectInfo');
      try {
        const pid = firebase.app().options.projectId || 'no-detectado';
        projectInfo.textContent = `Proyecto Firebase: ${pid}`;
        console.log('[INFO] Proyecto detectado:', pid);
      } catch (e) {
        projectInfo.textContent = 'No se pudo detectar proyecto';
        console.error(e);
      }

      // Identificador de cliente simple (para depuración si quieres). Persistente en localStorage.
      let clientId = localStorage.getItem('clientId_v1');
      if (!clientId) {
        clientId = Math.random().toString(36).slice(2, 10);
        localStorage.setItem('clientId_v1', clientId);
      }
      console.log('[INFO] clientId:', clientId);

      // Utilidad para crear elemento de la lista
      function createGameItem(doc) {
        const data = doc.data();
        const li = document.createElement('li');
        li.className = 'bg-slate-800 p-3 rounded flex justify-between items-center';
        li.dataset.id = doc.id;

        const name = document.createElement('div');
        name.textContent = data.name || '(sin nombre)';

        const right = document.createElement('div');
        right.className = 'flex items-center gap-2';

        const votes = document.createElement('span');
        votes.className = 'font-bold text-yellow-300';
        votes.textContent = (data.votes || 0);

        const voteBtn = document.createElement('button');
        voteBtn.className = 'px-2 py-1 rounded bg-green-600 hover:bg-green-700';
        voteBtn.textContent = '⬆️';
        voteBtn.onclick = () => voteGame(doc.id);

        right.appendChild(votes);
        right.appendChild(voteBtn);

        li.appendChild(name);
        li.appendChild(right);

        return li;
      }

      // AGREGAR JUEGO
      async function addGame() {
        const input = document.getElementById('gameInput');
        const name = input.value.trim();
        if (!name) return;
        try {
          await gamesRef.add({
            name,
            votes: 0,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            addedBy: clientId
          });
          input.value = '';
        } catch (err) {
          console.error('Error añadiendo juego:', err);
          alert('Error al añadir, mira la consola.');
        }
      }

      // VOTAR (incrementa)
      async function voteGame(id) {
        try {
          const docRef = gamesRef.doc(id);
          await docRef.update({ votes: firebase.firestore.FieldValue.increment(1) });
        } catch (err) {
          console.error('Error votando:', err);
        }
      }

      // -------------------------
      // LISTENER EN TIEMPO REAL
      // -------------------------
      let unsubscribe = null;

      function attachListener() {
        // Desuscribimos si ya había uno
        if (unsubscribe) unsubscribe();

        // Ordenamos por votes (desc). Esto devuelve un listener en tiempo real.
        unsubscribe = gamesRef.orderBy('votes', 'desc').onSnapshot(snapshot => {
          console.log('[SNAPSHOT] cambios recibidos, docs:', snapshot.docs.length);

          const list = document.getElementById('gameList');
          // Reconstruimos la lista: es simple y estable para 4-20 items.
          list.innerHTML = '';

          snapshot.forEach(doc => {
            const li = createGameItem(doc);
            list.appendChild(li);
          });

          // Log de cambios por si algo no se ve sincronizado
          snapshot.docChanges().forEach(change => {
            console.log('[DOC CHANGE]', change.type, change.doc.id, change.doc.data());
          });

        }, err => {
          console.error('[SNAPSHOT ERROR]', err);
          // Si hay error, lo mostramos en la UI
          projectInfo.textContent = 'Error con listener: ' + (err.message || err);
        });

        console.log('[INFO] Listener adjuntado.');
      }

      // Botones UI
      document.getElementById('addBtn').addEventListener('click', addGame);
      document.getElementById('forceBtn').addEventListener('click', () => {
        console.log('[ACTION] Fuerza re-attach listener');
        attachListener();
      });

      // Auto-attach al cargar
      attachListener();

      // -------------------------
      // FUNCIONES DE DEPURACIÓN ÚTILES
      // -------------------------
      // Muestra reglas actuales (NO puede leerse desde cliente) -> el admin comprueba en consola de Firebase.

      // Recomendaciones rápidas si no sincroniza:
      // 1) Comprueba que en la parte superior (Proyecto Firebase:) aparece el mismo nombre en ambas pestañas.
      // 2) Comprueba que Firestore está creado (Firestore Database -> Collections -> debe aparecer "games" después de añadir algo).
      // 3) Comprueba las reglas (Firebase Console -> Firestore -> Rules). Para pruebas temporales, usa:
      //    rules_version = '2';
      //    service cloud.firestore {
      //      match /databases/{database}/documents {
      //        match /{document=**} { allow read, write: if true; }
      //      }
      //    }
      // 4) Mira la consola del navegador (F12) para ver logs con '[SNAPSHOT]' o errores.

      console.log('Código listo — pega tus credenciales y recarga la web.');
    </script>
  </body>
</html>
