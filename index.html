<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lista de Juegos (Realtime + Usuarios)</title>

    <!-- Firebase compat libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-900 text-white min-h-screen">
    <div class="max-w-6xl mx-auto p-6 grid grid-cols-4 gap-6">

      <!-- LEFT: Online users -->
      <aside class="col-span-1 bg-slate-800 p-4 rounded">
        <h2 class="font-bold mb-2">ðŸŸ¢ En lÃ­nea <span id="onlineCount" class="text-slate-400">(0)</span></h2>
        <ul id="onlineList" class="space-y-2 text-sm"></ul>

        <div id="myInfo" class="mt-6 text-xs text-slate-400"></div>

        <div id="adminPanel" class="mt-4 hidden">
          <h3 class="font-semibold">Panel Admin</h3>
          <label class="text-xs text-slate-300">MÃ¡x votos por usuario</label>
          <div class="flex gap-2 mt-2">
            <input id="maxVotesInput" type="number" min="1" class="flex-1 p-2 rounded text-black" />
            <button id="saveMaxBtn" class="bg-indigo-600 px-3 rounded">Guardar</button>
          </div>
          <p id="adminMsg" class="text-xs mt-2 text-slate-400"></p>
        </div>
      </aside>

      <!-- MAIN: lista y acciones -->
      <main class="col-span-3">
        <header class="text-center mb-6">
          <h1 class="text-4xl font-extrabold">ðŸŽ® Lista de Juegos del Grupo</h1>
          <p id="projectInfo" class="text-sm text-slate-400 mt-2">Conectando...</p>
        </header>

        <!-- Form -->
        <div class="bg-slate-800 p-4 rounded mb-4">
          <div class="flex gap-3">
            <input id="gameInput" placeholder="Escribe un juego..." class="flex-1 p-3 rounded text-black" />
            <button id="addBtn" class="bg-blue-600 px-4 rounded font-semibold">Agregar Juego</button>
          </div>
          <p class="text-xs text-slate-400 mt-2">Puedes votar una sola vez por cada juego. MÃ¡x votos por usuario: <span id="maxVotesDisplay">-</span></p>
        </div>

        <!-- Game list -->
        <ul id="gameList" class="space-y-3"></ul>
      </main>

    </div>

    <!-- Login modal -->
    <div id="loginModal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden">
      <div class="bg-slate-800 p-6 rounded w-full max-w-md">
        <h2 class="text-xl font-bold mb-2">Elige un nombre</h2>
        <p class="text-sm text-slate-400 mb-4">Tu nombre serÃ¡ pÃºblico para cuando votes. Debe ser Ãºnico. Si eliges <strong>IronFly222</strong> tendrÃ¡s permisos de administrador.</p>
        <input id="usernameInput" placeholder="Tu nombre (ej. IronFly222)" class="w-full p-3 rounded text-black mb-3" />
        <div class="flex gap-2">
          <button id="startBtn" class="flex-1 bg-green-600 p-2 rounded font-semibold">Entrar</button>
        </div>
        <p id="loginError" class="text-red-400 text-sm mt-2"></p>
      </div>
    </div>

    <!-- Voters modal -->
    <div id="votersModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center">
      <div class="bg-slate-800 p-4 rounded w-full max-w-sm">
        <h3 class="font-bold">Votaron por <span id="votersGameName"></span></h3>
        <ul id="votersList" class="mt-3 text-sm"></ul>
        <div class="mt-3 text-right">
          <button id="closeVoters" class="bg-slate-600 px-3 py-1 rounded">Cerrar</button>
        </div>
      </div>
    </div>

    <script>
      // =========================================================
      // CONFIG: pega aquÃ­ tu firebaseConfig (desde la consola)
      // =========================================================
      const firebaseConfig = {
  apiKey: "AIzaSyCy7uSUohMousqtjg5asXZwHNXML9R2wlg",
  authDomain: "tier-games.firebaseapp.com",
  projectId: "tier-games",
  storageBucket: "tier-games.firebasestorage.app",
  messagingSenderId: "1000845489913",
  appId: "1:1000845489913:web:751c121638ec2e4e0f9428"
};


      // ---------------------------------------------------------
      // Inicializar
      // ---------------------------------------------------------
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      const rdb = firebase.database();

      const usersRef = db.collection('users');
      const usernamesRef = db.collection('usernames');
      const gamesRef = db.collection('games');
      const settingsRef = db.collection('meta').doc('settings');

      // Estado local
      let currentUser = null; // { uid, username, votesUsed, isAdmin }

      // ELEMENTOS
      const projectInfo = document.getElementById('projectInfo');
      const gameInput = document.getElementById('gameInput');
      const addBtn = document.getElementById('addBtn');
      const gameList = document.getElementById('gameList');
      const loginModal = document.getElementById('loginModal');
      const usernameInput = document.getElementById('usernameInput');
      const startBtn = document.getElementById('startBtn');
      const loginError = document.getElementById('loginError');
      const onlineList = document.getElementById('onlineList');
      const onlineCount = document.getElementById('onlineCount');
      const myInfo = document.getElementById('myInfo');
      const maxVotesDisplay = document.getElementById('maxVotesDisplay');
      const adminPanel = document.getElementById('adminPanel');
      const maxVotesInput = document.getElementById('maxVotesInput');
      const saveMaxBtn = document.getElementById('saveMaxBtn');

      // Voters modal
      const votersModal = document.getElementById('votersModal');
      const votersList = document.getElementById('votersList');
      const votersGameName = document.getElementById('votersGameName');
      const closeVoters = document.getElementById('closeVoters');

      // UI Events
      addBtn.addEventListener('click', addGame);
      startBtn.addEventListener('click', startWithUsername);
      closeVoters.addEventListener('click', () => votersModal.classList.add('hidden'));
      saveMaxBtn.addEventListener('click', saveMaxVotes);

      // =========================================================
      // Auth state
      // =========================================================
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
        auth.onAuthStateChanged(async user => {
          if (!user) {
            projectInfo.textContent = 'No autenticado';
            showLogin();
            return;
          }

          // Check if user doc exists
          const userDoc = await usersRef.doc(user.uid).get();
          if (!userDoc.exists) {
            // need username
            showLogin();
            projectInfo.textContent = 'Necesitas elegir nombre';
            return;
          }

          // User doc exists -> populate currentUser
          const u = userDoc.data();
          currentUser = {
            uid: user.uid,
            username: u.username,
            votesUsed: u.votesUsed || 0,
            isAdmin: u.isAdmin || false
          };

          projectInfo.textContent = `Conectado como: ${currentUser.username} (uid: ${currentUser.uid})`;
          hideLogin();
          afterLogin();
        });
      });

      // =========================================================
      // Login flow: pick username + create users & usernames docs atomically
      // =========================================================
      function showLogin() {
        loginModal.classList.remove('hidden');
      }
      function hideLogin() {
        loginModal.classList.add('hidden');
      }

      async function startWithUsername() {
        loginError.textContent = '';
        const chosen = usernameInput.value.trim();
        if (!chosen || chosen.length < 2) {
          loginError.textContent = 'Nombre demasiado corto';
          return;
        }

        const username = chosen;
        const lc = username.toLowerCase();

        try {
          // Ensure user is signed in (anonymous)
          let user = auth.currentUser;
          if (!user) {
            const cred = await auth.signInAnonymously();
            user = cred.user;
          }

          // Transaction: reserve username + create user doc
          await db.runTransaction(async tx => {
            const unameRef = usernamesRef.doc(lc);
            const unameSnap = await tx.get(unameRef);
            if (unameSnap.exists) throw new Error('El nombre ya estÃ¡ en uso. Elige otro.');

            const userRef = usersRef.doc(user.uid);
            const userSnap = await tx.get(userRef);
            if (userSnap.exists) {
              // If doc exists but username differs, prevent overwrite
              if (userSnap.data().username && userSnap.data().username !== username) {
                throw new Error('Tu cuenta ya tiene un nombre diferente.');
              }
            }

            tx.set(unameRef, { uid: user.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp() });

            tx.set(userRef, {
              username: username,
              votesUsed: 0,
              isAdmin: (username === 'IronFly222'),
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
          });

          // success
          loginError.textContent = '';
          usernameInput.value = '';
          hideLogin();
          // onAuthStateChanged will pick up userDoc and continue
        } catch (err) {
          console.error('Error registrando username:', err);
          loginError.textContent = err.message || 'Error al registrar nombre';
        }
      }

      // =========================================================
      // After login: presence + listeners
      // =========================================================
      let rdbStatusRef = null;

      async function afterLogin() {
        // Listen to user's doc changes
        usersRef.doc(currentUser.uid).onSnapshot(doc => {
          const d = doc.data();
          if (!d) return;
          currentUser.votesUsed = d.votesUsed || 0;
          currentUser.isAdmin = d.isAdmin || false;
          myInfo.innerHTML = `TÃº: <strong>${currentUser.username}</strong> â€” Votos usados: <strong>${currentUser.votesUsed}</strong>`;
          if (currentUser.isAdmin) {
            adminPanel.classList.remove('hidden');
            // load current max
            settingsRef.get().then(snap => {
              const val = snap.exists ? (snap.data().maxVotes || 5) : 5;
              maxVotesDisplay.textContent = val;
              maxVotesInput.value = val;
            });
          } else {
            adminPanel.classList.add('hidden');
          }
        });

        setupPresence();
        attachListeners();
      }

      // =========================================================
      // Presence (Realtime Database) â€” reliable with onDisconnect
      // =========================================================
      function setupPresence() {
        if (!currentUser) return;
        const uid = currentUser.uid;
        rdbStatusRef = rdb.ref('/status/' + uid);
        const connectedRef = rdb.ref('.info/connected');

        connectedRef.on('value', snap => {
          if (snap.val() === false) return;
          rdbStatusRef.onDisconnect().set({ state: 'offline', username: currentUser.username, last_changed: firebase.database.ServerValue.TIMESTAMP });
          rdbStatusRef.set({ state: 'online', username: currentUser.username, last_changed: firebase.database.ServerValue.TIMESTAMP });
        });

        // Listen to all statuses
        rdb.ref('/status').on('value', snap => {
          const list = snap.val() || {};
          onlineList.innerHTML = '';
          const names = [];
          Object.keys(list).forEach(k => {
            const v = list[k];
            if (v && v.state === 'online') {
              const li = document.createElement('li');
              li.textContent = v.username + (k === currentUser.uid ? ' (tÃº)' : '');
              onlineList.appendChild(li);
              names.push(v.username);
            }
          });
          onlineCount.textContent = '(' + names.length + ')';
        });
      }

      // =========================================================
      // Lista en realtime (Firestore)
      // =========================================================
      let gamesUnsub = null;

      function attachListeners() {
        // settings
        settingsRef.onSnapshot(snap => {
          const max = (snap.exists && snap.data().maxVotes) ? snap.data().maxVotes : 5;
          maxVotesDisplay.textContent = max;
        });

        if (gamesUnsub) gamesUnsub();
        gamesUnsub = gamesRef.orderBy('votes', 'desc').onSnapshot(snapshot => {
          gameList.innerHTML = '';
          snapshot.forEach(doc => {
            const data = doc.data();
            const li = document.createElement('li');
            li.className = 'bg-slate-800 p-3 rounded flex justify-between items-center';

            const left = document.createElement('div');
            left.innerHTML = `<div class="font-semibold">${escapeHtml(data.name)}</div><div class="text-xs text-slate-400">AÃ±adido por: ${escapeHtml(data.addedByName || data.addedBy || '-')}</div>`;

            const right = document.createElement('div');
            right.className = 'flex items-center gap-2';

            const votes = document.createElement('span');
            votes.className = 'font-bold text-yellow-300';
            votes.textContent = data.votes || 0;

            const voteBtn = document.createElement('button');
            voteBtn.className = 'px-2 py-1 rounded bg-green-600 hover:bg-green-700';
            voteBtn.textContent = 'â¬†ï¸';
            voteBtn.onclick = () => voteGame(doc.id);

            const whoBtn = document.createElement('button');
            whoBtn.className = 'px-2 py-1 rounded bg-slate-700 hover:bg-slate-600 text-xs';
            whoBtn.textContent = 'ðŸ‘ Ver';
            whoBtn.onclick = () => showVoters(doc.id, data.name);

            right.appendChild(votes);
            right.appendChild(voteBtn);
            right.appendChild(whoBtn);

            li.appendChild(left);
            li.appendChild(right);
            gameList.appendChild(li);
          });
        }, err => console.error('Listener games error:', err));
      }

      // =========================================================
      // AÃ±adir juego
      // =========================================================
      async function addGame() {
        if (!currentUser) {
          alert('Tienes que iniciar sesiÃ³n con un nombre primero.');
          showLogin();
          return;
        }
        const name = gameInput.value.trim();
        if (!name) return;
        try {
          await gamesRef.add({
            name,
            votes: 0,
            voters: {},
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            addedBy: currentUser.uid,
            addedByName: currentUser.username
          });
          gameInput.value = '';
        } catch (err) {
          console.error('Error aÃ±adiendo juego:', err);
          alert('Error al aÃ±adir juego. Mira la consola.');
        }
      }

      // =========================================================
      // Votar con transacciÃ³n (impide doble voto y respeta maxVotes)
      // =========================================================
      async function voteGame(gameId) {
        if (!currentUser) {
          alert('Necesitas iniciar sesiÃ³n');
          showLogin();
          return;
        }

        const uid = currentUser.uid;

        try {
          await db.runTransaction(async tx => {
            const gameRef = gamesRef.doc(gameId);
            const userRef = usersRef.doc(uid);
            const settingsSnap = await tx.get(settingsRef);
            const gameSnap = await tx.get(gameRef);
            const userSnap = await tx.get(userRef);

            if (!userSnap.exists) throw new Error('Usuario no encontrado. Vuelve a iniciar sesiÃ³n.');

            const maxVotes = (settingsSnap.exists && settingsSnap.data().maxVotes) ? settingsSnap.data().maxVotes : 5;
            const userData = userSnap.data();
            const used = userData.votesUsed || 0;
            if (used >= maxVotes) throw new Error('Has usado todos tus votos. Pide al admin que aumente el lÃ­mite.');

            const gameData = gameSnap.exists ? gameSnap.data() : { votes: 0, voters: {} };
            const voters = gameData.voters || {};
            if (voters[uid]) throw new Error('Ya votaste este juego.');

            // Apply updates
            tx.update(userRef, { votesUsed: used + 1 });

            // Either create or update game
            if (!gameSnap.exists) {
              tx.set(gameRef, {
                name: 'unknown',
                votes: 1,
                voters: { [uid]: userData.username },
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                addedBy: userData.uid || currentUser.uid,
                addedByName: userData.username
              });
            } else {
              const voterField = `voters.${uid}`;
              tx.update(gameRef, {
                votes: (gameData.votes || 0) + 1,
                [voterField]: userData.username
              });
            }
          });

          console.log('Voto registrado');
        } catch (err) {
          console.error('Error votando:', err);
          alert(err.message || 'Error al votar.');
        }
      }

      // =========================================================
      // Mostrar quiÃ©n votÃ³
      // =========================================================
      async function showVoters(gameId, gameName) {
        const doc = await gamesRef.doc(gameId).get();
        if (!doc.exists) {
          alert('Juego no encontrado');
          return;
        }
        const data = doc.data();
        const voters = data.voters || {};
        votersGameName.textContent = gameName;
        votersList.innerHTML = '';
        Object.keys(voters).forEach(uid => {
          const li = document.createElement('li');
          li.textContent = voters[uid];
          votersList.appendChild(li);
        });
        votersModal.classList.remove('hidden');
      }

      // =========================================================
      // Admin: guardar maxVotes
      // =========================================================
      async function saveMaxVotes() {
        if (!currentUser || !currentUser.isAdmin) return alert('No autorizado');
        const v = parseInt(maxVotesInput.value || '5');
        if (isNaN(v) || v < 1) return alert('Valor invÃ¡lido');
        try {
          await settingsRef.set({ maxVotes: v }, { merge: true });
          adminMsg.textContent = 'Guardado';
        } catch (err) {
          console.error('Error guardando maxVotes', err);
          alert('Error guardando configuraciÃ³n');
        }
      }

      // =========================================================
      // Helpers
      // =========================================================
      function escapeHtml(text) {
        return String(text || '').replace(/[&<>"']/g, function (m) {
          return ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m];
        });
      }

      // =========================================================
      // START: show login if not authed
      // =========================================================
      // If already logged in, onAuthStateChanged will handle.

      console.log('App cargada. Pega tus credenciales y asegÃºrate de activar Auth, Firestore y Realtime DB en Firebase.');
    </script>
  </body>
</html>