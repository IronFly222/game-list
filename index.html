<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lista de Juegos (Realtime + Usuarios)</title>

    <!-- Firebase compat libraries -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-900 text-white min-h-screen">
    <div class="max-w-6xl mx-auto p-6 grid grid-cols-4 gap-6">

      <!-- LEFT: Online users -->
      <aside class="col-span-1 bg-slate-800 p-4 rounded">
        <h2 class="font-bold mb-2">游릭 En l칤nea <span id="onlineCount" class="text-slate-400">(0)</span></h2>
        <ul id="onlineList" class="space-y-2 text-sm"></ul>

        <div id="myInfo" class="mt-6 text-xs text-slate-400"></div>

        <div id="adminPanel" class="mt-4 hidden">
          <h3 class="font-semibold">Panel Admin</h3>
          <label class="text-xs text-slate-300">M치x votos por usuario</label>
          <div class="flex gap-2 mt-2">
            <input id="maxVotesInput" type="number" min="1" class="flex-1 p-2 rounded text-black" />
            <button id="saveMaxBtn" class="bg-indigo-600 px-3 rounded">Guardar</button>
          </div>
          <p id="adminMsg" class="text-xs mt-2 text-slate-400"></p>
        </div>
      </aside>

      <!-- MAIN: lista y acciones -->
      <main class="col-span-3">
        <header class="text-center mb-6">
          <h1 class="text-4xl font-extrabold">游꿡 Lista de Juegos del Grupo</h1>
          <p id="projectInfo" class="text-sm text-slate-400 mt-2">Conectando...</p>
        </header>

        <!-- Form -->
        <div class="bg-slate-800 p-4 rounded mb-4">
          <div class="flex gap-3">
            <input id="gameInput" placeholder="Escribe un juego..." class="flex-1 p-3 rounded text-black" />
            <button id="addBtn" class="bg-blue-600 px-4 rounded font-semibold">Agregar Juego</button>
          </div>
          <p class="text-xs text-slate-400 mt-2">Puedes votar una sola vez por cada juego. M치x votos por usuario: <span id="maxVotesDisplay">-</span></p>
        </div>

        <!-- Game list -->
        <ul id="gameList" class="space-y-3"></ul>
      </main>

    </div>

    <!-- Login modal -->
    <div id="loginModal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden">
      <div class="bg-slate-800 p-6 rounded w-full max-w-md">
        <h2 class="text-xl font-bold mb-2">Elige un nombre</h2>
        <p class="text-sm text-slate-400 mb-4">Tu nombre ser치 p칰blico para cuando votes. Debe ser 칰nico. Si eliges <strong>IronFly222</strong> tendr치s permisos de administrador.</p>
        <input id="usernameInput" placeholder="Tu nombre (ej. IronFly222)" class="w-full p-3 rounded text-black mb-3" />
        <div class="flex gap-2">
          <button id="startBtn" class="flex-1 bg-green-600 p-2 rounded font-semibold">Entrar</button>
        </div>
        <p id="loginError" class="text-red-400 text-sm mt-2"></p>
      </div>
    </div>

    <!-- Voters modal -->
    <div id="votersModal" class="fixed inset-0 bg-black/60 hidden items-center justify-center">
      <div class="bg-slate-800 p-4 rounded w-full max-w-sm">
        <h3 class="font-bold">Votaron por <span id="votersGameName"></span></h3>
        <ul id="votersList" class="mt-3 text-sm"></ul>
        <div class="mt-3 text-right">
          <button id="closeVoters" class="bg-slate-600 px-3 py-1 rounded">Cerrar</button>
        </div>
      </div>
    </div>

    <script>
      // =========================================================
      // CONFIG: pega aqu칤 tu firebaseConfig (desde la consola)
      // =========================================================
      const firebaseConfig = {
        apiKey: "AIzaSyCy7uSUohMousqtjg5asXZwHNXML9R2wlg",
        authDomain: "tier-games.firebaseapp.com",
        projectId: "tier-games",
        storageBucket: "tier-games.firebasestorage.app",
        messagingSenderId: "1000845489913",
        appId: "1:1000845489913:web:751c121638ec2e4e0f9428"
      };

      // ---------------------------------------------------------
      // Inicializar
      // ---------------------------------------------------------
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
      const rdb = firebase.database();

      const usersRef = db.collection('users');
      const usernamesRef = db.collection('usernames');
      const gamesRef = db.collection('games');
      const settingsRef = db.collection('meta').doc('settings');

      // Estado local
      let currentUser = null; // { uid, username, votesUsed, isAdmin }

      // ELEMENTOS
      const projectInfo = document.getElementById('projectInfo');
      const gameInput = document.getElementById('gameInput');
      const addBtn = document.getElementById('addBtn');
      const gameList = document.getElementById('gameList');
      const loginModal = document.getElementById('loginModal');
      const usernameInput = document.getElementById('usernameInput');
      const startBtn = document.getElementById('startBtn');
      const loginError = document.getElementById('loginError');
      const onlineList = document.getElementById('onlineList');
      const onlineCount = document.getElementById('onlineCount');
      const myInfo = document.getElementById('myInfo');
      const maxVotesDisplay = document.getElementById('maxVotesDisplay');
      const adminPanel = document.getElementById('adminPanel');
      const maxVotesInput = document.getElementById('maxVotesInput');
      const saveMaxBtn = document.getElementById('saveMaxBtn');
      const adminMsg = document.getElementById('adminMsg');

      // Voters modal
      const votersModal = document.getElementById('votersModal');
      const votersList = document.getElementById('votersList');
      const votersGameName = document.getElementById('votersGameName');
      const closeVoters = document.getElementById('closeVoters');

      // UI Events
      addBtn.addEventListener('click', addGame);
      startBtn.addEventListener('click', startWithUsername);
      closeVoters.addEventListener('click', () => votersModal.classList.add('hidden'));
      saveMaxBtn.addEventListener('click', saveMaxVotes);

      // =========================================================
      // Auth state
      // =========================================================
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {
        auth.onAuthStateChanged(async user => {
          if (!user) {
            projectInfo.textContent = 'No autenticado';
            showLogin();
            return;
          }

          // Check if user doc exists
          const userDoc = await usersRef.doc(user.uid).get();
          if (!userDoc.exists) {
            // need username
            showLogin();
            projectInfo.textContent = 'Necesitas elegir nombre';
            return;
          }

          // User doc exists -> populate currentUser
          const u = userDoc.data();
          currentUser = {
            uid: user.uid,
            username: u.username,
            votesUsed: u.votesUsed || 0,
            isAdmin: u.isAdmin || false
          };

          projectInfo.textContent = `Conectado como: ${currentUser.username} (uid: ${currentUser.uid})`;
          hideLogin();
          afterLogin();
        });
      });

      // =========================================================
      // Login flow: pick username + create users & usernames docs atomically
      // =========================================================
      function showLogin() {
        loginModal.classList.remove('hidden');
      }
      function hideLogin() {
        loginModal.classList.add('hidden');
      }

      async function startWithUsername() {
        loginError.textContent = '';
        const chosen = usernameInput.value.trim();
        if (!chosen || chosen.length < 2) {
          loginError.textContent = 'Nombre demasiado corto';
          return;
        }

        const username = chosen;
        const lc = username.toLowerCase();

        try {
          // Ensure user is signed in (anonymous)
          let user = auth.currentUser;
          if (!user) {
            const cred = await auth.signInAnonymously();
            user = cred.user;
          }

          // Transaction: reserve username + create user doc
          await db.runTransaction(async tx => {
            const unameRef = usernamesRef.doc(lc);
            const unameSnap = await tx.get(unameRef);
            if (unameSnap.exists) throw new Error('El nombre ya est치 en uso. Elige otro.');

            const userRef = usersRef.doc(user.uid);
            const userSnap = await tx.get(userRef);
            if (userSnap.exists) {
              // If doc exists but username differs, prevent overwrite
              if (userSnap.data().username && userSnap.data().username !== username) {
                throw new Error('Tu cuenta ya tiene un nombre diferente.');
              }
           
